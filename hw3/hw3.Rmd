---
title: "Biostat M280 Homework 3"
subtitle: Due Mar 2 @ 11:59PM
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Q1 LA City Employee Payroll

The `/home/m280-data/la_payroll/LA_City_Employee_Payroll.csv` file on teaching server contains payroll information of LA City employees in years 2013-2017. It was downloaded from [LA City Controller's Office](https://controllerdata.lacity.org/Payroll/City-Employee-Payroll/pazn-qyym). Make a Shiny app to facilitate exploratory data analysis. 

1. For efficiency of the Shiny app, you should first pre-process, pare down, tidy, and save the data, e.g., as a compressed RDS file, to be used in the app.


0. **Total payroll by LA City**. Visualize the total LA City payroll of each year, with breakdown into base pay, overtime pay, and other pay.

0. **Who earned most?** Visualize the payroll information (total payment with breakdown into base pay, overtime pay, and other pay, Department, Job Title) of the top $n$ highest paid LA City employees in a specific year. User specifies $n$ (default 10) and year (default 2017).

0. **Which departments earn most?** Visualize the mean or median payroll, with breakdown into base pay, overtime pay, and other pay, of top $n$ earning departments. User specifies $n$ (default 5), year (default 2017), and method (mean or median, default median).

0. **Which departments cost most?** Visualize the total payroll, with breakdown into base pay, overtime pay, and other pay, of top $n$ expensive departments. User specifies $n$ (default 5) and year (default 2017).

0. Visualize any other information you are interested in.

0. Publish your Shiny app to <https://www.shinyapps.io> and share the link.

## Q2 LA City Parking War

    ```{r}
    # load packages and datasets
    if (!"tidyverse" %in% rownames(installed.packages()))  
      install.packages("tidyverse", repos = "http://cran.rstudio.com/")
    if (!"DBI" %in% rownames(installed.packages()))  
      install.packages("DBI", repos = "http://cran.rstudio.com/")
    if (!"RSQLite" %in% rownames(installed.packages()))  
      install.packages("RSQLite", repos = "http://cran.rstudio.com/")
    if (!"dbplyr" %in% rownames(installed.packages()))  
      install.packages("dbplyr", repos = "http://cran.rstudio.com/") 
    if (!"knitr" %in% rownames(installed.packages()))  
      install.packages("knitr", repos = "http://cran.rstudio.com/") 
    suppressMessages(library(tidyverse))
    suppressMessages(library(DBI))
    suppressMessages(library(RSQLite))
    suppressMessages(library(dbplyr))
    suppressMessages(library(knitr))
    ```

The SQLite database `/home/m280-data/la_parking/LA_Parking_Citations.sqlite` on teaching server contains information about parking tickets in LA City. It was downloaded from [LA Open Data Portal](https://data.lacity.org/A-Well-Run-City/Parking-Citations/wjz9-h9np). Connect to the database and answer following questions using plots and summary statistics. In this exercise, you are **not** allowed to load whole data into memory. Use the _transform in database, plot in R_ strategy.

    ```{r}
    db <- dbConnect(RSQLite::SQLite(), dbname = 
                    "/home/m280-data/la_parking/LA_Parking_Citations_Extra.sqlite")
    dbListTables(db)
    latix_sql <- dplyr::tbl(db, "latix")
    latix_sql %>% print(width = Inf)
    #res <- dbSendQuery(db, "SELECT * FROM latix")
    #dbFetch(res)
    #dbDisconect(db)
    ```

1. How many tickets are in this data set? Which time period do these tickets span? Which years have most data?

    ```{r}
    latix_sql %>%
      summarise(n_distinct(Ticket_number))
    
    # including NA ticket numbers
    count(latix_sql)
    ```

    ```{sql connection=db}
    SELECT COUNT(Ticket_number) FROM latix
    ```

    ```{r}
    first <- latix_sql %>%
      filter(!is.na(Issue_Year)) %>%
      select(Issue_Year, Issue_Month, Issue_Day, Issue_Hour, Issue_Minute) %>%
      arrange(Issue_Year, Issue_Month, Issue_Day, Issue_Hour, Issue_Minute)
    head(first, 1) 
      
    last <- latix_sql %>%
      filter(!is.na(Issue_Year)) %>%
      select(Issue_Year, Issue_Month, Issue_Day, Issue_Hour, Issue_Minute) %>%
      arrange(desc(Issue_Year), desc(Issue_Month), desc(Issue_Day), 
              desc(Issue_Hour), desc(Issue_Minute))
    head(last, 1)   

    #filter(row_number()==1 | row_number()==n())
    
    ```

    ```{r}
    # which years have most data?
    latix_sql %>%
      filter(!is.na(Issue_Year)) %>%
      group_by(Issue_Year) %>%
      count() %>%
      collect() %>%
      ggplot() + 
        geom_col(aes(x = Issue_Year, y = n)) +
        scale_x_continuous("Issue Year", breaks = c(2010, 2011, 2012, 2013, 
                                                    2014, 2015, 2016, 2017))
    ```


0. When (which hour, weekday, month day, and month) are you most likely to get a ticket and when are you least likely to get a ticket?

    ```{r}
    latix_sql %>%
      filter(!is.na(Issue_Hour)) %>%
      group_by(Issue_Hour) %>%
      summarise(num = n()) %>%
      collect() %>%
      ggplot() +
        geom_col(aes(x = Issue_Hour, y = num)) 

    latix_sql %>%
      filter(!is.na(Issue_Wday)) %>%
      group_by(Issue_Wday) %>%
      summarise(num = n()) %>%
      collect() %>%
      ggplot() +
        geom_col(aes(x = Issue_Wday, y = num)) +
        scale_x_continuous("Issue Weekday", 
                           breaks = c(1, 2, 3, 4, 5, 6, 7),
                           label = c("Sun", "Mon", "Tue", "Wed", "Thurs", "Fri", 
                                     "Sat"))
    latix_sql %>%
      filter(!is.na(Issue_Day)) %>%
      group_by(Issue_Day) %>%
      summarise(num = n()) %>%
      collect() %>%
      ggplot() +
        geom_col(aes(x = Issue_Day, y = num)) +
        scale_x_continuous("Issue Month Day", breaks = c(1, 5, 10, 15, 20, 25, 30))
    
    latix_sql %>%
      filter(!is.na(Issue_Month)) %>%
      group_by(Issue_Month) %>%
      summarise(num = n()) %>%
      collect() %>%
      ggplot() +
        geom_col(aes(x = Issue_Month, y = num)) + 
        scale_x_continuous("Issue Month", 
                           breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12),
                           label = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))

    ```

0. Which car makes received most citations?

    ```{r}
    latix_sql %>%
      filter(!is.na(Make)) %>%
      group_by(Make) %>%
      summarise(num = n()) %>%
      arrange(desc(num)) %>%
      collect() %>%
      top_n(5) %>%
      ggplot() +
        geom_col(aes(x = Make, y = num))
      
    ```

0. How many different colors of cars were ticketed? Which color attracted most tickets?
    ```{r}
    latix_sql %>%
      summarise(n_distinct(Color))
    
    latix_sql %>%
      filter(!is.na(Color)) %>%
      count(Color) %>%
      arrange(desc(n)) %>%
      collect() %>%
      top_n(1)
      
    ```


0. What are the most common ticket types?
    ```{r}
    latix_sql %>%
      filter(!is.na(Violation_Description)) %>%
      group_by(Violation_Description) %>%
      summarise(num = n()) %>%
      arrange(desc(num)) %>%
      collect() %>%
      top_n(5) %>%
      kable()
    ```

0. How much money was collected on parking tickets in 2015 and 2016?
    ```{r}
    
    ```


0. Visualize any other information you are interested in.
